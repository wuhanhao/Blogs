# 计算机操作系统——概论、进程与线程

## 一、概述

### 定义

#### **资源管理的观点**

操作系统是控制和管理计算机的软、硬件资源，合理地组织计算机的工作流程，以及方便用户的程序集合。

#### **用户的观点(扩展机器的观点)**

操作系统是配置在计算机硬件上的第一层软件，是对硬件系统的第一次扩充。
![](https://github.com/wuhanhao/Blogs/blob/master/Pictures/OS/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%94%A8%E6%88%B7%E7%9A%84%E8%A7%82%E7%82%B9.png?raw=true)

> 注意：操作系统的地位：紧贴硬件（裸机）之上，所有其他软件之下。

### 基本特征

#### **并发**

**并发** 是指宏观上在一段时间内能同时运行多个程序 或者说 两个或两个以上的事物在同一时间间隔内发生，

而并行则指同一时刻能运行多个指令。并行需要硬件支持，如多流水线或者多处理器。

操作系统通过引入进程和线程，使得程序能够并发运行。

#### 共享

**共享** 是指系统中的资源可以被多个并发进程共同使用 或者说 系统中的软、硬件资源在其上的供多个程序共同享用。

**有两种共享方式**

- **互斥共享方式**
- **同时共享方式或者共同访问方式**

互斥共享的资源称为临界资源，例如打印机等，在同一时间只允许一个进程访问，需要用同步机制来实现对临界资源的访问。

共同访问是指某时间段内，允许多个进程同时访问。如：磁盘。

#### 虚拟

**虚拟技术**把一个物理实体转换为多个逻辑实体 或者说 通过某种技术手段把一个物理上的实体，变成多个

逻辑上的对应物。

**主要有两种虚拟技术**

- **时分复用技术**
- **空分复用技术**

多个进程能在同一个处理器上并发执行使用了**时分复用技术**，让每个进程轮流占有处理器，每次只执行一小个**时间片**并快速切换。

虚拟内存使用了**空分复用技术**，它将物理内存抽象为地址空间，每个进程都有各自的地址空间。地址空间和物理内存使用页进行交换，地址空间的页并不需要全部在物理内存中，当使用到一个没有在物理内存的页时，执行页面置换算法，将该页置换到内存中。

#### 不确定性（异步）

**不确定性**也称随机性，是指系统中各种事件的发生顺序是不确定的 或者说 指进程不是一次性执行完毕，而是走走停停，以不可知的速度向前推进。

### 基本功能

#### 进程管理（处理机管理）

**任务**

- 对处理机的**分配**和**运行**实施有效管理。

在**多道程序**环境下，处理机的分配和运行以**进程**为单位，因此对处理机的管理即对进程的管理。

**功能**

- 进程控制
- 进程同步
- 进程通信
- 进程调度等

#### 存储管理（内存管理）

存储管理要管理的资源是内存存储器（简称内存）。

**任务**

- 方便用户使用内存
- 提高内存的利用率
- 从逻辑上扩充内存

**功能**

- 内存分配
- 地址映射
- 内存保护
- 内存扩充等

#### 设备管理

设备管理是操作系统中最庞杂、最琐碎的部分。

**任务**

- 完成用户程序请求的I/O操作，为用户程序分配I/O设备
- 提高外部设备的利用率
- 尽可能地提高输入/输出的速度
- 方便用户使用外部设备

**功能**

- 设备分配
- 设备控制
- 设备无关性

#### 文件管理（信息资源管理）

**任务**

- 大量的信息(程序和数据集)以文件的形式放在**外存**，
- 对信息的管理也就是对文件的管理。

**功能**

- 文件存储空间的管理
- 目录管理
- 文件的读/写管理
- 文件的存取控制

### 接口

#### 命令接口

- 联机命令接口
- 脱机命令接口
- 图形用户界面（命令接口的改版）

#### 程序接口

也称系统调用

**成熟的**

- 批处理操作系统
- 分时操作系统
- 实时操作系统

**发展中的**

- 微机操作系统
- 多处理机操作系统
- 网络操作系统
- 分布式操作系统
- 嵌入式操作系统

#### 批处理操作系统

单道：内存中仅放一道作业

作业的完成顺序与进驻内存的顺序相关

多道：内存中放多道作业

作业的完成顺序与进驻内存的顺序无严格对应关系

优点：资源利用率高、系统吞吐量大

缺点：平均周转时间长、无交互能力

#### 分时操作系统

允许多个终端用户同时使用计算机，在这样的系统中，用户感觉不到其他用户的存在，好象独占计算机一样。

**类型**

- 简单分时系统
- 具有前后台的分时系统
- 多道分时系统

**特征**

- 多路性
- 独立性
- 交互性
- 及时性

#### 实时操作系统

对外部输入的信息，实时系统能够在规定的时间内处理完毕并作出反应。

**类型**

- 闭环——实时控制系统
- 开环——实时信息处理系统

**特殊要求**

- 高可靠性
- 过载保护
- 对截止时间的要求

#### 微机操作系统

- CP/M 操作系统
- MS-DOS 操作系统
- OS/2  操作系统
- Windows 操作系统

- UNIX及类UNIX 操作系统

  - Solaris  

  - SVR4SCO 

  - OpenServer

  - SCO Unix Ware 7

  - Xenix 

  - Linux

- Mac OS X操作系统

#### 多处理机操作系统

**引入原因**

- 增加系统吞吐量
- 节省投资
- 提高系统可靠性

**多处理机OS类型**

- 非对称多处理模式——主-从模式
- 对称多处理模式—— 独立管理模式

#### 网络操作系统

**网络OS模式**

- 客户/服务器模式——Client/server
- 对等模式——Peer to Peer

**网络OS功能**

- 网络通信
- 资源共享管理
- 网络服务
- 网络管理
- 互操作能力

#### 分布式操作系统

分布式操作系统是由若干个计算机经互连网络连接而成的，这些计算机既可以独立工作，又能协同工作。可实现系统内的资源管理，任务动态分配，并能并行地运行分布式程序。

**分布式OS特点**

- 多机合作
- 健壮性
- 透明性
- 共享性

#### 嵌入式操作系统

计算机发展的趋势之一是体积越来越小，掌上电脑和嵌入式系统随机出现。掌上电脑也称PDA。

嵌入式计算机：顾名思义即将计算机嵌入到其他设备上，这些设备无处不在，大到汽车发动机、机器人，小到电视机、微波炉、移动电话。运行在其上的操作系统比较简单，只实现所要求的控制功能。

## 二、进程与线程

### 进程的引入

#### 程序的顺序执行

![](https://github.com/wuhanhao/Blogs/blob/master/Pictures/OS/%E7%A8%8B%E5%BA%8F%E7%9A%84%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C.jpg?raw=true)

P1：	a=x+y

P2: 		b=a-5

P3:  	c=b+1

**特点**

- 顺序性：程序在处理机上执行时，处理机的操作严格按照规定顺序执行，即只有前一个操作结束后，才能执行后一个操作。

- 封闭性：程序是在封闭的环境中运行的。即程序在执行时，独占系统中的全部资源，因而系统内资源的状态只有该程序才能改变它，与外界环境无关。

- 可再现性：当程序被重复执行时，只要其初始条件相同，其程序多次执行的结果相同。

#### 程序的并发执行

![](https://github.com/wuhanhao/Blogs/blob/master/Pictures/OS/%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%B9%B6%E5%8F%91%E6%89%A7%E8%A1%8C.jpg?raw=true)

P1：	a=5

P2：    	b=6

P3：    	c=a+b

P4：   	d=c+1

**特点：**

- 间断性：程序在并发执行时，形成了相互制约关系。相互制约将导致并发程序具有”执行—暂停—执行”这种间断性的活动规律。
- 失去封闭性：系统中的资源供多个程序共享，致使程序的运行失去了封闭性。
- 失去可再现性：程序在并发执行时，由于失去了封闭性，也将失去其可再现性。

#### 程序并发执行的条件——Bernstein条件

**Bernstein条件**

读集：R(Pi)={a1,a2,……,am}  程序Pi执行期间参考的变量集合

写集：W(Pi)={b1,b2,……,bm}  程序Pi执行期间改变的变量集合

两个进程P1， P2若满足：

**R(P1)∩W(P2)∪R(P2)∩W(P1)∪W(P1)∩W(P2)={}**

则P1， P2并发执行，且具有可再现性。

**Bernstein条件——例1**

P1：a=5

P2：b=6

R(P1)={}		W(P1)={a}

R(P2)={}		W(P2)={b}

**R(P1) ∩W(P2)={}**		   **R(P2) ∩W(P1)={}**		**W(P1) ∩W(P2)={}**

**R(P1)∩W(P2)∪R(P2)∩W(P1)∪W(P1)∩W(P2)={}**

P1、P2**可以**并发执行

**Bernstein条件——例2**

P3：c=a+b

P4：d=c+1

R(P3)={a,b}  		W(P3)={c}

R(P4)={c}  		W(P4)={d}

**R(P3) ∩W(P4)={}		R(P4) ∩W(P3)={c}**

**R(P3) ∩W(P4) ∪R(P4) ∩W(P3)∪W(P3)∩W(P4) ={c}**

P3、P4**不能**并发执行

#### 进程的定义

至今，进程没有一个统一的定义。

**进程** 是资源分配的基本单位。

**进程** 可以定义为”并发执行的程序在一个数据集合上的执行过程“。

#### 进程与程序的关系

  **进程**                                                        **程序**

动态性                                                     静态性

并发性                                                     顺序性

暂时性                                                     永久性

数据结构=程序+数据+PCB

程序与进程不是一一对应关系

### 进程的状态及其组成

#### **进程状态转换图**

![](https://github.com/wuhanhao/Blogs/blob/master/Pictures/OS/%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%9B%BE.png?raw=true)

#### **五种状态的进程状态转换图**

![](https://github.com/wuhanhao/Blogs/blob/master/Pictures/OS/%E4%BA%94%E7%A7%8D%E7%8A%B6%E6%80%81%E7%9A%84%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%9B%BE.png?raw=true)

#### **双挂起状态的进程状态转换图**

![](https://github.com/wuhanhao/Blogs/blob/master/Pictures/OS/%E5%8F%8C%E6%8C%82%E8%B5%B7%E7%8A%B6%E6%80%81%E7%9A%84%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%9B%BE.png?raw=true)

**应该注意以下内容：**

- 只有就绪态和运行态可以相互转换，其它的都是单向转换。就绪状态的进程通过调度算法从而获得 CPU 时间，转为运行状态；而运行状态的进程，在分配给它的 CPU 时间片用完之后就会转为就绪状态，等待下一次调度。
- 阻塞状态是缺少需要的资源从而由运行状态转换而来，但是该资源不包括 CPU 时间，缺少 CPU 时间会从运行态转换为就绪态。

### 进程控制块PCB

**进程控制块** (Process Control Block, **PCB**) 描述进程的基本信息和运行状态，所谓的创建进程和撤销进程，都是指对 PCB 的操作。因此，进程控制块是进程存在的唯一标识。

**PCB** 是进程实体的一部分，是OS中最重要的数据结构。

**进程的组成**：进程控制块PCB、程序段、数据段、堆栈。

**PCB的作用** 就是使一个在多道程序环境下不能独立运行的程序能成为一个独立运行的基本单位，并可和其他进程并发执行。

#### 进程控制块PCB的内容

##### **进程描述信息**

- 进程名  
- 进程标识符
- 用户名

##### **进程调度信息**

- 进程状态
- 进程优先级
- 运行统计信息
- 进程阻塞原因

##### **处理机状态信息**

- 通用寄存器
- 指令计数器
- 程序状态字寄存器
- 栈指针

##### **进程控制和资源占有量信息**

- 程序入口地址
- 程序的外存地址
- 进程同步及通信机制
- 资源占有信息
- 链接指针

##### 进程控制块PCB的组织

链接方式

![](https://github.com/wuhanhao/Blogs/blob/master/Pictures/OS/%E9%93%BE%E6%8E%A5%E6%96%B9%E5%BC%8F.png?raw=true)

### 进程控制

#### 操作系统内核

**核心态**：具有较高的特权，能执行一切命令，访问所有寄存器和存储区。

**用户态**：具有较低特权，只能执行规定的命令，访问指定的寄存器和存储区。

**内核**：硬件的第一次延伸。系统将一些与硬件紧密相关的模块放在内核。中断处理，时钟管理。内核在执行某些基本操作时，往往是利用原语操作实现的。

**原语**：原语由若干条指令构成、用于完成一定功能的过程。原语是“原子操作”。即一个操作中的所有动作，要么全做，要么全不做。换言之，原子操作是一个不可分割的操作。因此，原语在被执行时是不可以被中断的。

#### 进程家族树

![](https://github.com/wuhanhao/Blogs/blob/master/Pictures/OS/%E9%93%BE%E6%8E%A5%E6%96%B9%E5%BC%8F.png?raw=true)

#### 进程的创建与撤消

##### 进程的创建

**引起进程创建的事件**

- 用户登录
- 新作业进入系统
- 提供服务
- 应用请求

**创建原语要做的工作**

- 申请空白PCB
- 为进程分配资源
- 初始化进程描述信息（初始化PCB）：初始化进程描述信息、初始化处理机状态信息、初始化进程控制信息
- 将新进程插入就绪队列

##### 进程的撤销

**引起进程撤消的事件**

- 进程正常结束
- 进程异常结束
- 外界干预

**撤消原语要做的工作**

- 查找撤消进程的PCB
- 若进程处于执行状态，终止之，并进行进程调度
- 若有子孙，予以终止
- 归还资源
- 从所在队列移出

#### **进程的阻塞与唤醒**

##### **引起进程阻塞的事件**

- 请求系统服务
- 启动某种操作
- 数据尚未到达
- 无新工作可做

##### **阻塞原语要做的工作**

- 停止进程的执行
- 将进程插入阻塞队列，改变进程在PCB中的状态
- 重新调度

##### **唤醒原语要做的工作**

- 将进程从阻塞队列解下
- 将进程插入就绪队列
- 改变进程在PCB中的状态

#### **进程的挂起与激活**

##### **挂起原语要做的工作**

- 检查被挂起进程的状态
- 如进程处于就绪状态，将进程从就绪状态变为就绪挂起状态
- 如进程处于阻塞状态，将进程从阻塞状态变为阻塞挂起状态
- 如进程正在运行，将进程变为就绪挂起状态，并重新调度

##### **激活原语要做的工作**

- 检查被激活进程的状态
- 如进程处于就绪挂起状态，将进程从就绪挂起状态变为就绪状态
- 如进程处于阻塞挂起状态，将进程从阻塞挂起状态变为阻塞状态
- 若系统为抢占式系统，则进行进程调度

### 线程

#### 线程的引入

**进程有两个基本属性**

- 进程是拥有资源的独立单位
- 进程是独立调度和分派的基本单位

由于进程是资源拥有者，因而在进程的创建、撤消和切换中系统必须为之付出较大的时间、空间开销。因此，系统中所设置的进程的数目不宜过多，进程切换的频率不宜过高。这就限制了进程并发程度的提高。

一个进程中可以有多个线程，它们共享进程资源。

#### 进程与线程的关系

![](https://github.com/wuhanhao/Blogs/blob/master/Pictures/OS/%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%85%B3%E7%B3%BB.png?raw=true)

**操作系统中的进程和线程可以设计为以上四种**

QQ 和浏览器是两个进程，浏览器进程里面有很多线程，例如 HTTP 请求线程、事件响应线程、渲染线程等等，线程的并发执行使得在浏览器中点击一个新链接从而发起 HTTP 请求时，浏览器还可以响应用户的其它事件。

![](https://github.com/wuhanhao/Blogs/blob/master/Pictures/OS/QQ%E5%92%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%A4%E4%B8%AA%E8%BF%9B%E7%A8%8B.png?raw=true)



#### 线程的定义

线程是进程中的一个实体，是系统独立调度和分派的基本单位

[^进程的属性之一]: 是系统独立调度和分派的基本单位

#### 进程模型

![](https://github.com/wuhanhao/Blogs/blob/master/Pictures/OS/%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B.png?raw=true)

- **进程是资源的拥有者**
- **线程不拥有资源，只有TCB及堆栈**

#### 进程和线程比较

##### **调度**

线程调度快，需要空间小。进程因拥有资源，调度时因负担过重而缓慢。

线程是独立调度的基本单位，在同一进程中，线程的切换不会引起进程切换，从一个进程内的线程切换到另一个进程中的线程时，会引起进程切换。

##### 并发性

在引入线程的操作系统中，不仅进程之间可以并发执行，一个进程中的多个线程之间亦可并发执行。

##### 拥有资源

进程是资源分配的基本单位，但是线程不拥有资源，线程可以访问隶属进程的资源。即**进程是资源的拥有者**。

##### 系统开销

进程切换的开销远远大于线程切换的开销，线程的切换省去了资源的回收。

由于创建或撤销进程时，系统都要为之分配或回收资源，如内存空间、I/O 设备等，所付出的开销远大于创建或撤销线程时的开销。类似地，在进行进程切换时，涉及当前执行进程 CPU 环境的保存及新调度进程 CPU 环境的设置，而线程切换时只需保存和设置少量寄存器内容，开销很小。
